rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Checks if a document exists for update/delete operations.
    function isExistingDoc() {
      return resource != null;
    }

    // Checks if the requesting user is the owner or a member of a given project.
    // This requires a 'get' operation, which has a small performance/cost impact.
    function isProjectMember(projectId) {
      let projectData = get(/databases/$(database)/documents/projects/$(projectId)).data;
      return request.auth.uid == projectData.ownerId || request.auth.uid in projectData.memberIds;
    }

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) A new user signing up: auth.uid matches {userId}.
     * @allow (get) Any authenticated user can read profile details of other users for collaboration.
     * @allow (list) Any authenticated user can list all users in the system for collaboration features.
     * @deny (update) A user trying to modify another user's profile.
     * @principle Restricts write access to a user's own data, allows reads for collaboration.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      // CORREÇÃO: Permite listar usuários para atribuir tarefas (dropdowns)
      allow list: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && isExistingDoc() && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && isExistingDoc();
    }

    /**
     * @description Controls access to user-specific notifications.
     * @path /users/{userId}/notifications/{notificationId}
     * @allow (update) A user marking their own notification as read.
     * @deny (create) A user attempting to create a notification for themself (should be done by Cloud Functions).
     * @deny (get) A user trying to read another user's notifications.
     * @principle Enforces strict data ownership for private information.
     */
    match /users/{userId}/notifications/{notificationId} {
      allow get, list: if isOwner(userId);
      allow create: if false; // Notifications are created by backend functions, not clients.
      allow update: if isOwner(userId) && isExistingDoc();
      allow delete: if isOwner(userId) && isExistingDoc();
    }

    /**
     * @description Controls access to project documents.
     * @path /projects/{projectId}
     * @allow (create) An authenticated user creating a new project and setting themselves as owner.
     * @allow (get) A user who is a member of the project reading its details.
     * @allow (list) An authenticated user can list projects they are a member of.
     * @deny (delete) A project member (not owner) trying to delete the project.
     * @principle Implements shared access based on an explicit membership list.
     */
    match /projects/{projectId} {
      allow list: if isSignedIn();
      allow get: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isProjectMember(projectId) && isExistingDoc() && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isSignedIn() && isOwner(resource.data.ownerId) && isExistingDoc();
    }

    /**
     * @description Controls access to tasks within a project.
     * @path /projects/{projectId}/tasks/{taskId}
     * @allow (get) A project member viewing a task.
     * @allow (list) A project member listing all tasks in the project.
     * @deny (create) A non-member trying to add a task to a project.
     * @principle Access is inherited from the parent project's membership.
     */
    match /projects/{projectId}/tasks/{taskId} {
      allow get, list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectMember(projectId) && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && isProjectMember(projectId) && isExistingDoc() && request.resource.data.projectId == resource.data.projectId;
      allow delete: if isSignedIn() && isProjectMember(projectId) && isExistingDoc();
    }

    /**
     * @description Controls access to subtasks within a task.
     * @path /projects/{projectId}/tasks/{taskId}/subtasks/{subtaskId}
     * @allow (create) A project member adding a subtask to a task.
     * @deny (update) A non-member trying to check off a subtask.
     * @principle Access is inherited from the parent project's membership.
     */
    match /projects/{projectId}/tasks/{taskId}/subtasks/{subtaskId} {
      allow get, list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectMember(projectId) && request.resource.data.taskId == taskId;
      allow update: if isSignedIn() && isProjectMember(projectId) && isExistingDoc() && request.resource.data.taskId == resource.data.taskId;
      allow delete: if isSignedIn() && isProjectMember(projectId) && isExistingDoc();
    }

    /**
     * @description Controls access to attachments on a task.
     * @path /projects/{projectId}/tasks/{taskId}/attachments/{attachmentId}
     * @allow (create) A project member adding an attachment.
     * @deny (delete) A non-member trying to delete an attachment.
     * @principle Access is inherited from the parent project's membership.
     */
    match /projects/{projectId}/tasks/{taskId}/attachments/{attachmentId} {
      allow get, list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectMember(projectId) && request.resource.data.taskId == taskId;
      allow update: if isSignedIn() && isProjectMember(projectId) && isExistingDoc() && request.resource.data.taskId == resource.data.taskId;
      allow delete: if isSignedIn() && isProjectMember(projectId) && isExistingDoc();
    }

    /**
     * @description Controls access to comments on a task.
     * @path /projects/{projectId}/tasks/{taskId}/comments/{commentId}
     * @allow (create) A project member adding a comment and setting themself as author.
     * @allow (delete) A comment author deleting their own comment.
     * @deny (update) A project member trying to edit another user's comment.
     * @principle Access is inherited from the parent project, with writes restricted to the comment author.
     */
    match /projects/{projectId}/tasks/{taskId}/comments/{commentId} {
      allow get, list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectMember(projectId) && request.resource.data.authorId == request.auth.uid && request.resource.data.taskId == taskId;
      allow update: if isSignedIn() && isOwner(resource.data.authorId) && isExistingDoc();
      allow delete: if isSignedIn() && isOwner(resource.data.authorId) && isExistingDoc();
    }

    /**
     * @description Controls access to global tags.
     * @path /tags/{tagId}
     * @allow (get) Any signed-in user can read tags.
     * @allow (create) Any signed-in user can create new tags for the system.
     * @deny (update) No user can update a tag, to prevent vandalism.
     * @deny (delete) No user can delete a tag, to prevent breaking other tasks.
     * @principle Provides public read and controlled create for global, non-owned data.
     */
    match /tags/{tagId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls real-time presence data for tasks.
     * @path /presence/{taskId}/{userId}
     * @allow (create) A user setting their own presence on a task.
     * @deny (get) Any user reading presence data. This is denied because the path structure does not allow securely checking if the reader has access to the task.
     * @deny (update) A user trying to change another user's presence status.
     * @principle Enforces document ownership for writes. Reads are disabled due to insecure data path.
     */
    match /presence/{taskId}/{userId} {
      // CRITICAL: Reads are disallowed because there's no way to link {taskId} back to a project
      // to check for membership. To enable reads, change path to /projects/{projectId}/tasks/{taskId}/presence/{userId}.
      allow get, list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && isExistingDoc();
      allow delete: if isOwner(userId) && isExistingDoc();
    }
  }
}